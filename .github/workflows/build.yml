name: Build Arch-Forge Repo

on:
  push:
    paths:
      - 'packages.txt'
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      options: --privileged

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Arch Environment & US Mirrors
        run: |
          # 初始化 Keyring
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Sy --noconfirm archlinux-keyring
          
          # 安装必要工具 (pacman-contrib 包含 paccache 用于清理旧包)
          pacman -S --noconfirm reflector git rsync sudo pacman-contrib

          # 自动筛选美国最快源
          echo "Selecting best US mirrors..."
          reflector --country 'United States' --age 12 --protocol https --sort rate --save /etc/pacman.d/mirrorlist
          pacman -Syyu --noconfirm

      - name: Setup Builder User
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          # 确保 builder 对整个工作目录有初始权限
          chown -R builder:builder .

      - name: Install Yay
        run: |
          sudo -u builder bash -c '
            cd /tmp
            git clone https://aur.archlinux.org/yay-bin.git
            cd yay-bin
            makepkg -si --noconfirm
          '

      - name: Build Packages
        run: |
          # 【修复点 1】显式创建目录并授权
          mkdir -p tmp_build
          mkdir -p repo_dir/x86_64
          chown -R builder:builder .

          # 读取包名
          packages=$(cat packages.txt | tr '\n' ' ')
          echo "Target packages: $packages"

          # 【修复点 2】使用绝对路径执行构建
          sudo -u builder yay -S --noconfirm --builddir=$(pwd)/tmp_build $packages

          # 将编译好的包移入仓库目录
          find tmp_build -name "*.pkg.tar.zst" -exec cp {} ./repo_dir/x86_64/ \;

      - name: Update Repo Database
        run: |
          # 【修复点 3】强制将权限切回 root，确保 repo-add 有权写文件
          chown -R root:root ./repo_dir
          
          cd repo_dir/x86_64
          
          # 检查是否有包生成，如果没有则报错停止，方便排查
          ls -lh *.pkg.tar.zst || (echo "No packages found!" && exit 1)

          # 清理超过 2 个的历史版本（防止磁盘满）
          paccache -r -k 2 -c . || true

          # 更新数据库
          # 使用更稳健的参数：-n (只加新包), -R (移除旧链接)
          repo-add -n -R arch-forge.db.tar.gz *.pkg.tar.zst
          
          # 确保 pacman 能通过标准 .db 文件名访问
          cp -f arch-forge.db.tar.gz arch-forge.db
          cp -f arch-forge.files.tar.gz arch-forge.files

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo_dir
          publish_branch: gh-pages
          keep_files: true # 必须开启，否则每次构建都会删掉之前的包

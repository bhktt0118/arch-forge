name: Build Arch-Forge Repo

on:
  push:
    paths:
      - 'packages.txt'
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  contents: write # 必须赋予写入 Release 的权限

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      options: --privileged

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Arch Environment & US Mirrors
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Sy --noconfirm archlinux-keyring
          pacman -S --noconfirm reflector git rsync sudo pacman-contrib

          # 自动筛选美国最快源
          echo "Selecting best US mirrors..."
          reflector --country 'United States' --age 12 --protocol https --sort rate --save /etc/pacman.d/mirrorlist
          pacman -Syyu --noconfirm

      - name: Setup Builder User
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder .

      - name: Install Yay (AUR Helper)
        run: |
          sudo -u builder bash -c '
            cd /tmp
            git clone https://aur.archlinux.org/yay-bin.git
            cd yay-bin
            makepkg -si --noconfirm
          '

      - name: Build Packages
        run: |
          # 创建必要目录
          mkdir -p repo_output
          mkdir -p tmp_build
          chown -R builder:builder .

          # 读取并编译
          packages=$(cat packages.txt | tr '\n' ' ')
          echo "Building targets: $packages"
          sudo -u builder yay -S --noconfirm --builddir=$(pwd)/tmp_build $packages

          # 收集所有生成的包（包括依赖包）
          find tmp_build -name "*.pkg.tar.zst" -exec cp {} ./repo_output/ \;

      - name: Update Repo Database
        run: |
          cd repo_output
          
          # 生成仓库数据库文件
          # -n: 仅增加新包，-R: 移除旧包链接
          repo-add -n -R arch-forge.db.tar.gz *.pkg.tar.zst
          
          # 处理数据库文件链接问题，方便后续直接引用
          rm -f arch-forge.db arch-forge.files
          cp arch-forge.db.tar.gz arch-forge.db
          cp arch-forge.files.tar.gz arch-forge.files
          
          echo "Build complete. Files in repo_output:"
          ls -lh

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Arch-Forge Repository (Latest Build)"
          body: |
            This release contains the latest pre-compiled Arch Linux packages from AUR.
            Updated on: ${{ github.event.head_commit.timestamp || 'Manual Trigger' }}
          files: |
            repo_output/*.pkg.tar.zst
            repo_output/arch-forge.db
            repo_output/arch-forge.files
          # 设为 true 会在每次运行时覆盖旧的 Release 文件
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

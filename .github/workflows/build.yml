name: Build Arch-Forge Repo

on:
  push:
    paths:
      - 'packages.txt'      # 修改包列表时触发
      - '.github/workflows/**'
  schedule:
    - cron: '0 2 * * 0'     # 每周日凌晨2点(UTC)自动更新重新编译
  workflow_dispatch:        # 允许手动按钮触发

# 设置权限，允许 Actions 写入仓库以发布 Pages
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      options: --privileged # 构建某些包需要特权

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      # 1. 初始化 Arch 环境与美国镜像源
      - name: Setup Arch Environment & US Mirrors
        run: |
          # 初始化密钥环
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Sy --noconfirm archlinux-keyring

          # 安装必要工具: reflector(选源), git, rsync
          pacman -S --noconfirm reflector git rsync

          # [核心需求] 自动筛选美国、最新、同步最快的 HTTPS 源
          echo "Selecting best US mirrors..."
          reflector --country 'United States' --age 12 --protocol https --sort rate --save /etc/pacman.d/mirrorlist
          
          # 刷新数据库
          pacman -Syyu --noconfirm

      # 2. 创建构建用户 (Makepkg 不允许 root)
      - name: Setup Builder User
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chmod -R a+rw .

      # 3. 安装 AUR 助手 (Yay) - 用于自动处理依赖
      - name: Install Yay
        run: |
          sudo -u builder bash -c '
            cd /tmp
            git clone https://aur.archlinux.org/yay-bin.git
            cd yay-bin
            makepkg -si --noconfirm
          '

      # 4. 准备本地仓库目录 (拉取现有的 gh-pages 分支，以便增量更新)
      - name: Checkout Existing Repo (if exists)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: repo_dir
        continue-on-error: true # 如果是第一次运行，分支不存在，忽略错误

      - name: Create Repo Dir if missing
        run: mkdir -p repo_dir/x86_64

      # 5. 开始编译 (自动处理递归依赖)
      - name: Build Packages
        run: |
          # 给予 builder 用户对工作区的权限
          chown -R builder:builder .
          
          # 读取列表并转换为单行
          packages=$(cat packages.txt | tr '\n' ' ')
          echo "Building targets: $packages"

          # 使用 yay 编译
          # --builddir: 指定构建目录
          # --noconfirm: 自动确认
          sudo -u builder yay -S --noconfirm --builddir=./tmp_build $packages

          # 将编译好的包 (.pkg.tar.zst) 移动到仓库目录
          # 注意：find 会找到所有依赖包（如果它们也被编译了的话）
          find ./tmp_build -name "*.pkg.tar.zst" -exec cp {} ./repo_dir/x86_64/ \;

      # 6. 生成/更新仓库数据库 (Pacman 索引)
      - name: Update Repo Database
        run: |
          cd repo_dir/x86_64
          # 名字就在这里定义：arch-forge
          repo-add -n -R arch-forge.db.tar.gz *.pkg.tar.zst
          
          # 清理软链接，保留实体文件，方便 HTTP 服务器托管
          rm -f arch-forge.db arch-forge.files
          cp arch-forge.db.tar.gz arch-forge.db
          cp arch-forge.files.tar.gz arch-forge.files
          
          # (可选) 清理旧包，防止仓库无限膨胀，保留最新的1个版本
          # 这里使用 accretion/paccache 等逻辑比较复杂，简单起见，暂不清理或建议定期手动清理

      # 7. 部署到 GitHub Pages (完全免费)
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo_dir
          publish_branch: gh-pages
          force_orphan: false # 保留提交历史
          keep_files: true    # 这是一个增量更新的关键

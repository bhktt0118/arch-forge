name: Build Arch-Forge Repo

on:
  push:
    paths:
      - 'packages.txt'
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      options: --privileged

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Arch Environment & US Mirrors
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Sy --noconfirm archlinux-keyring
          pacman -S --noconfirm reflector git rsync sudo pacman-contrib

          # 自动筛选美国最快源，确保下载依赖不卡顿
          echo "Selecting best US mirrors..."
          reflector --country 'United States' --age 12 --protocol https --sort rate --save /etc/pacman.d/mirrorlist
          pacman -Syyu --noconfirm

      - name: Setup Builder User
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder .

      - name: Install Yay (AUR Helper)
        run: |
          sudo -u builder bash -c '
            cd /tmp
            git clone https://aur.archlinux.org/yay-bin.git
            cd yay-bin
            makepkg -si --noconfirm
          '

      - name: Build Packages
        run: |
          # 1. 确保目录存在且权限正确
          mkdir -p tmp_build
          mkdir -p repo_dir/x86_64
          chown -R builder:builder .

          # 2. 读取需要编译的包
          packages=$(cat packages.txt | tr '\n' ' ')
          echo "Building: $packages"

          # 3. 使用 yay 编译（自动处理所有依赖）
          sudo -u builder yay -S --noconfirm --builddir=$(pwd)/tmp_build $packages

          # 4. 收集生成的包文件
          find tmp_build -name "*.pkg.tar.zst" -exec cp {} ./repo_dir/x86_64/ \;

      - name: Update Repo Database
        run: |
          # 强制将权限设回 root 以执行数据库更新
          chown -R root:root ./repo_dir
          cd repo_dir/x86_64
          
          # 检查包是否存在
          ls -lh *.pkg.tar.zst || (echo "No packages found!" && exit 1)

          # 清理旧包，只保留最新的两个版本
          paccache -r -k 2 -c . || true

          # 【修复核心】先删除旧的数据库文件和可能的软链接
          rm -f arch-forge.db arch-forge.db.tar.gz arch-forge.files arch-forge.files.tar.gz
          
          # 生成新的仓库索引
          repo-add -n -R arch-forge.db.tar.gz *.pkg.tar.zst
          
          # 【修复核心】删除 repo-add 自动生成的软链接，改为拷贝实体文件
          # 这样可以避免 "same file" 报错，且对 GitHub Pages 更友好
          rm -f arch-forge.db arch-forge.files
          cp arch-forge.db.tar.gz arch-forge.db
          cp arch-forge.files.tar.gz arch-forge.files

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo_dir
          publish_branch: gh-pages
          keep_files: true
